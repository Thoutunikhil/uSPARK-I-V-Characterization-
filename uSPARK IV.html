<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>uSPARK I-V Console | MMNE Lab</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
:root {
--bits-blue: #003d7c;
--bits-red: #e31837;
--dark: #1e293b;
--success: #10b981;
--card-bg: #ffffff;
}

body {
font-family: 'Inter', -apple-system, sans-serif;
background-color: #f1f5f9;
margin: 0;
color: var(--dark);
display: flex;
flex-direction: column;
min-height: 100vh;
}

/* Responsive Header */
header {
background: var(--bits-blue);
color: white;
padding: 1.5rem;
text-align: center;
box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
border-bottom: 4px solid var(--bits-red);
}

.container {
width: 95%;
max-width: 1200px;
margin: 1.5rem auto;
display: grid;
grid-template-columns: 1fr;
gap: 1.5rem;
}

@media (min-width: 992px) {
.container { grid-template-columns: 350px 1fr; }
}

/* Glassmorphism Cards */
.card {
background: var(--card-bg);
border-radius: 16px;
padding: 1.5rem;
box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
border: 1px solid rgba(0,0,0,0.05);
}

/* Status Badge */
.status-bar {
display: flex;
align-items: center;
gap: 10px;
font-weight: 600;
margin-bottom: 1.5rem;
padding: 10px;
border-radius: 8px;
background: #f8fafc;
}
.dot { width: 12px; height: 12px; border-radius: 50%; background: #94a3b8; }
.connected .dot { background: var(--success); box-shadow: 0 0 10px var(--success); }

/* Modern Controls */
.input-group { margin-bottom: 1.2rem; }
label { display: block; font-size: 0.8rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 5px; }
select, input {
width: 100%;
padding: 12px;
border: 2px solid #e2e8f0;
border-radius: 10px;
font-size: 1rem;
transition: all 0.2s;
}
select:focus { border-color: var(--bits-blue); outline: none; }

/* Action Buttons */
.btn {
cursor: pointer;
border: none;
border-radius: 10px;
padding: 14px 20px;
font-weight: 700;
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
transition: all 0.2s;
width: 100%;
margin-bottom: 10px;
}
.btn-blue { background: var(--bits-blue); color: white; }
.btn-green { background: var(--success); color: white; }
.btn-outline { background: white; border: 2px solid var(--bits-blue); color: var(--bits-blue); }
.btn:active { transform: scale(0.98); }

/* Plot/Table Area */
.chart-container { position: relative; height: 300px; margin-bottom: 1.5rem; }
.table-wrapper {
overflow-x: auto;
max-height: 400px;
border-radius: 8px;
border: 1px solid #e2e8f0;
}
table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
th { background: #f8fafc; padding: 12px; text-align: left; position: sticky; top: 0; }
td { padding: 12px; border-top: 1px solid #e2e8f0; font-family: 'Courier New', monospace; }

.v-badge { color: var(--bits-blue); font-weight: bold; }
.i-badge { color: var(--bits-red); font-weight: bold; }
</style>
</head>
<body>

<header>
<h1 style="margin:0;">uSPARK I-V Console</h1>
<div style="font-size: 0.9rem; margin-top: 5px;">Micro & Nanoelectronics Lab | BITS Pilani Hyderabad</div>
</header>

<div class="container">
<aside>
<div class="card">
<div id="statusIndicator" class="status-bar">
<div class="dot"></div> <span id="statusText">System Offline</span>
</div>

<button id="connectBtn" class="btn btn-blue">
<i data-lucide="bluetooth"></i> Scan for uSPARK
</button>

<div class="input-group">
<label>Current Range</label>
<select id="prefix">
<option value="1e3">Milli (mA)</option>
<option value="1e6" selected>Micro (ÂµA)</option>
<option value="1e9">Nano (nA)</option>
<option value="1e12">Pico (pA)</option>
</select>
</div>

<div class="input-group">
<label>X-Axis (Variable)</label>
<select id="xAxisSelect">
<option value="voltage">Voltage (V)</option>
<option value="time">Time Index</option>
</select>
</div>

<button id="exportBtn" class="btn btn-green">
<i data-lucide="download"></i> Export CSV
</button>

<button id="clearBtn" class="btn btn-outline">
<i data-lucide="trash-2"></i> Clear Data
</button>
</div>
</aside>

<main>
<div class="card" style="margin-bottom: 1.5rem;">
<div class="chart-container">
<canvas id="liveChart"></canvas>
</div>
</div>

<div class="card">
<h3 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
<i data-lucide="list"></i> Real-time Data Log
</h3>
<div class="table-wrapper">
<table id="dataTable">
<thead>
<tr>
<th>#</th>
<th>Voltage (V)</th>
<th>Current (Scaled)</th>
<th>System Time</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>
</div>
</main>
</div>

<script>
// Initialize Lucide Icons
lucide.createIcons();

let device, server, characteristic;
let dataHistory = [];
let chart;

// Chart Configuration
const initChart = () => {
const ctx = document.getElementById('liveChart').getContext('2d');
chart = new Chart(ctx, {
type: 'line',
data: {
datasets: [{
label: 'I-V Curve',
data: [],
borderColor: '#e31837',
borderWidth: 3,
pointRadius: 2,
backgroundColor: 'rgba(227, 24, 55, 0.05)',
fill: true,
tension: 0.2
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
x: { type: 'linear', title: { display: true, text: 'Voltage (V)' } },
y: { title: { display: true, text: 'Current' } }
},
plugins: { legend: { display: false } }
}
});
};

// Bluetooth Logic
document.getElementById('connectBtn').addEventListener('click', async () => {
try {
// This searches for ANY Bluetooth device with the GATT UART service
// You can also change this to acceptAllDevices: true if you don't use filters
device = await navigator.bluetooth.requestDevice({
acceptAllDevices: true,
optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb'] // Common UART UUID
});

const server = await device.gatt.connect();
const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
characteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');

await characteristic.startNotifications();
characteristic.addEventListener('characteristicvaluechanged', handleData);

document.getElementById('statusIndicator').classList.add('connected');
document.getElementById('statusText').innerText = "Connected: " + device.name;
document.getElementById('connectBtn').innerHTML = '<i data-lucide="check-circle"></i> Linked';
document.getElementById('connectBtn').style.background = "#64748b";
lucide.createIcons();
} catch (err) {
console.error(err);
alert("Bluetooth Error: Make sure Bluetooth is on and you are using a supported browser.");
}
});

function handleData(event) {
const decoder = new TextDecoder();
const rawString = decoder.decode(event.target.value);

// Expected incoming format: "V,I" e.g. "0.5,0.0000012"
const parts = rawString.trim().split(',');
if (parts.length >= 2) {
const v = parseFloat(parts[0]);
const i = parseFloat(parts[1]);
const scale = parseFloat(document.getElementById('prefix').value);
const scaledI = i * scale;

const dataObj = {
id: dataHistory.length + 1,
voltage: v,
current: scaledI,
time: new Date().toLocaleTimeString().split(' ')[0]
};

dataHistory.push(dataObj);
updateUI(dataObj);
}
}

function updateUI(data) {
// Update Table (Newest on top)
const tbody = document.getElementById('tableBody');
const row = `<tr>
<td>${data.id}</td>
<td class="v-badge">${data.voltage.toFixed(4)}</td>
<td class="i-badge">${data.current.toFixed(4)}</td>
<td>${data.time}</td>
</tr>`;
tbody.insertAdjacentHTML('afterbegin', row);

// Update Chart
const xMode = document.getElementById('xAxisSelect').value;
const xVal = xMode === 'voltage' ? data.voltage : data.id;

chart.data.datasets[0].data.push({ x: xVal, y: data.current });

// Dynamic Axis Labels
const prefixText = document.getElementById('prefix').options[document.getElementById('prefix').selectedIndex].text;
chart.options.scales.y.title.text = "Current (" + prefixText.split('(')[1];
chart.options.scales.x.title.text = xMode === 'voltage' ? "Voltage (V)" : "Reading Index";

chart.update('none');
}

// Export Function
document.getElementById('exportBtn').addEventListener('click', () => {
if(dataHistory.length === 0) return alert("No data to export!");
let csv = "Sequence,Voltage(V),Current(Scaled),Timestamp\n";
dataHistory.forEach(d => {
csv += `${d.id},${d.voltage},${d.current},${d.time}\n`;
});
const blob = new Blob([csv], { type: 'text/csv' });
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `uSPARK_Log_${Date.now()}.csv`;
a.click();
});

// Clear Logic
document.getElementById('clearBtn').addEventListener('click', () => {
if(confirm("Clear all logged data?")) {
dataHistory = [];
document.getElementById('tableBody').innerHTML = '';
chart.data.datasets[0].data = [];
chart.update();
}
});

window.onload = initChart;
</script>
</body>
</html>
